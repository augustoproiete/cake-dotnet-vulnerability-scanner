using Cake.Frosting;
using Cake.VulnerabilityScanner;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;

namespace Build
{
    class Program
    {
        public static int Main(string[] args)
        {
            return new CakeHost()
                .Run(args);
        }
    }

    [TaskName("scan pacakges")]
    public sealed class ScanPackagesTask : AsyncFrostingTask<FrostingContext>
    {
        public override async Task RunAsync(FrostingContext context)
        {
            // SonaType token,  base64 username:password
            var ossIndexToken = context.Environment.GetEnvironmentVariable("OSS_INDEX_TOKEN");
            await context.ScanPackagesAsync(new ScanPackagesSettings
            {
                Ecosystem="nuget",
                FailOnVulnerability=true,
                OssIndexBaseUrl="https://ossindex.sonatype.org/",
                OssIndexToken=ossIndexToken,
                SolutionFile="../../../../../Cake.VulnerabilityScanner.sln",
                Verbosity= Microsoft.Extensions.Logging.LogLevel.Debug,
                postScanCallback= (pacakgesInfo, scanResult) =>
                {
                    new PostScanHandler().Handle(pacakgesInfo, scanResult?.ToList());
                } 
            }, CancellationToken.None);
        }
    }

    [TaskName("Default")]
    [IsDependentOn(typeof(ScanPackagesTask))]
    public class DefaultTask : FrostingTask
    {
    }

    public class PostScanHandler
    {
        public void Handle(List<PackageInfo> packageInfos, List<ComponentReport> componentReports)
        {
            // the passed data could be processed here, for instance saved to a data store.
            Console.WriteLine("{0} pacakges have been found",packageInfos?.Count);
            Console.WriteLine("{0} pacakges with Vulnerabilities have been  found ", componentReports?.Count(x=> x.Vulnerabilities.Any()));
        }
    }
}
